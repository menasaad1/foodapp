Architecture Design & Implementation Plan: Global Food Delivery Platform Goal Description Refactor the existing "Emarat Food App" (Next.js Monolith) into a scalable, enterprise-grade Microservices Architecture. The goal is to separate concerns, enable independent scaling, and provide distinct interfaces for Customers, Admins, Restaurants, and Delivery Agents. User Review Required IMPORTANT Monorepo Restructuring: We propose moving the existing Next.js app into a apps/customer directory to facilitate a Monorepo structure. This affects file paths and build scripts. Supabase Transition: The current app relies on Supabase. We will abstract Supabase behind specific services (Auth Service, User Service) or migrate logic to custom microservices while loosely coupling with Supabase for the database layer initially. Architecture Overview High-Level Components API Gateway & BFF: API Gateway: Handles cross-cutting concerns (Auth, Rate Limiting, SSL Termination). BFF Layer (Backend for Frontend): Aggregation and orchestration layer behind the Gateway, tailored for each client (Customer, Restaurant, Admin) to prevent over-fetching. Microservices (Database-per-service pattern): Data Strategy: Each microservice strictly owns its database schema and migrations to prevent tight coupling. No direct DB access across services. Auth Service: Identity, JWT, RBAC, OTP, UAE Pass integration (future-proof). User Service: Dedicated profile management for Customers, Admins, Agents, Owners. Restaurant Service: Menu, Inventory, Opening Hours. Order Service: Cart, Checkout, Pricing Engine (Commissions/Dynamic Pricing), State Machine. Delivery Service: Driver assignment, Live Tracking, Geo-fencing. Payment Service: UAE Payment Gateway integration, Invoice generation, payout calculation. Notification Service: Emails, Push Notifications. Service Ownership: Each service has a defined SLA and clear ownership boundaries. Observability Stack: Logging: ELK Stack or Loki. Metrics: Prometheus & Grafana. Tracing: OpenTelemetry (Jaeger/Tempo). Security & Compliance: Rate Limiting: Redis-based sliding window. UAE Compliance: Data residency checks, GDPR-compliant logs. WAF/DDoS: Cloudflare or AWS Shield. Proposed Changes Phase 1: Structure & Foundation (Monorepo Setup) We will restructure the repository to support multiple applications and services. [NEW] Directory Structure / /apps /customer (Moved existing Next.js app) /admin (New) /restaurant (New) /services /auth-service /restaurant-service /order-service /delivery-service /packages /ui (Shared components) /common (Shared types/utils) /infra /docker /k8s Phase 2: Core Services Implementation [NEW] [Auth Service] Tech: Node.js (NestJS) Features: Login/Register (Email, Phone/OTP, Google). Token Management (Access/Refresh flow). RBAC Middleware (Super Admin, Restaurant Owner, etc.). Note: Will integrate with Supabase Auth or replace depending on strictness of requirements. [NEW] [Restaurant Service] Tech: Node.js (NestJS) Features: CRUD for Restaurants. Menu Management (Categories, Items, Add-ons). Image Uploads (S3/Supabase Storage). [NEW] [Payment Service] Tech: Node.js (NestJS), PostgreSQL Features: Integration with UAE Gateways (Stripe UAE, Checkout.com, PayTabs). Secure webhook handling. Pricing & Commission Logic: centralized calculation engine for Platform fees vs Restaurant payout. [NEW] [User Service] Tech: Node.js (NestJS), PostgreSQL Features: Profile hydration for all roles (Customer, Admin, Agent, Owner). Address Book management. Preference settings. Phase 4: Reliability & Events [NEW] [Event Bus & Resilience] Tech: RabbitMQ / Kafka Schema: AsyncAPI definitions for strictly typed events (OrderCreated, PaymentSuccess). Versioning: Event schemas are versioned to ensure backward compatibility. Policies: Dead Letter Queues (DLQ) and exponential backoff retries. [NEW] [Observability & Security] Monitor: Setup detailed Prometheus metrics for every service endpoint. Trace: Distributed tracing for full request lifecycle visibility. Rate Limits: Global and per-user limits at the BFF/Gateway level. Verification Plan Automated Tests Unit Tests: Jest/Vitest for logic in services. Integration Tests: Supertest for API endpoints. E2E: Playwright for critical flows (Login -> Order -> Checkout). Manual Verification Auth Flow: Verify Login/Register for all 4 roles. Order Flow: Create Order in Customer App -> See in Restaurant App -> Assign to Driver. Migration: Verify existing data (if any) is preserved or mocks are working. Deployment Strategy Local: Docker Compose bringing up all services + DBs is supported. Production: Kubernetes manifests (Helm Charts) for scalability. Rollout Strategy: Blue/Green Deployments: For zero-downtime updates. Canary Releases: Gradual traffic shifting for critical services (e.g., Order Service) to minimize risk. Feature Flags: Use feature flags to control the rollout of new features without redeployments. 